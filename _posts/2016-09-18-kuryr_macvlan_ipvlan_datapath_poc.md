---
title: Kuryr libnetwork -- ipvlan data path
---

## Backgroup

> Kuryr want to use vlan-aware-vms feature in VM-Nested Case. Last week there is a new proposal base on use IPVlan and allowed address pairs,for more detail, please see [Mail list](https://marc.ttias.be/openstack-dev/2016-09/msg00806.php) . This blog want to manually create an Environment to see how this proposal works.

## Environment

I use OSP9(Mitaka) as my openstack base environment. Here is my test Environment:

![Test Environment](https://raw.githubusercontent.com/LipingMao/LipingMao.github.io/master/_posts/picture/2016_09_18_1.png)

Notes:

- I use macvlan (ipvlan should be similar) in this test environment.
- I use network namespace to simulate docker container.


## Setup Steps

#### Overall Steps:

> I create private network(192.168.0.0/24) in neutron, then I create two VMs(VM1 192.168.0.4, VM2 192.168.0.5) . I create two neutron ports (192.168.0.6 and 192.168.0.7) for network namespace to use. Then On VM2, I create two macvlan interfaces and add them into different network namespace, and configure IPs. Then update the allowed address pairs, at last, the Network namespace can ping other VMs and outside.

#### Detail Steps:

##### 1. Create Private Network and Two VMs on this network.

```
# neutron net-show  53abf3be-cbcd-428a-9c27-3be3357d182f
+-------------------------+--------------------------------------+
| Field                   | Value                                |
+-------------------------+--------------------------------------+
| admin_state_up          | True                                 |
| availability_zone_hints |                                      |
| availability_zones      | nova                                 |
| created_at              | 2016-09-18T05:53:27                  |
| description             |                                      |
| id                      | 53abf3be-cbcd-428a-9c27-3be3357d182f |
| ipv4_address_scope      |                                      |
| ipv6_address_scope      |                                      |
| mtu                     | 1450                                 |
| name                    | private                              |
| port_security_enabled   | True                                 |
| qos_policy_id           |                                      |
| router:external         | False                                |
| shared                  | False                                |
| status                  | ACTIVE                               |
| subnets                 | 5ec3c71b-3de4-41f2-b6fb-aaae7d51f3d6 |
| tags                    |                                      |
| tenant_id               | b701b2d0922c41f580a063b0a1a020ba     |
| updated_at              | 2016-09-18T05:53:27                  |
+-------------------------+--------------------------------------+

# nova list
+--------------------------------------+------+--------+------------+-------------+------------------------------------+
| ID                                   | Name | Status | Task State | Power State | Networks                           |
+--------------------------------------+------+--------+------------+-------------+------------------------------------+
| c20ae412-9681-406f-8666-4887bb350474 | vm1  | ACTIVE | -          | Running     | private=192.168.0.4, 10.225.14.106 |
| 58907f59-65db-4190-b20d-d253b3a2b227 | vm2  | ACTIVE | -          | Running     | private=192.168.0.5                |
+--------------------------------------+------+--------+------------+-------------+------------------------------------+
```


#### 2. Create two neutron ports for two containers:

```
# neutron port-create --name macvlan1 53abf3be-cbcd-428a-9c27-3be3357d182f
# neutron port-create --name macvlan2 53abf3be-cbcd-428a-9c27-3be3357d182f
# neutron port-list | grep macvlan
| 3aa4b9a3-ef6d-4dbf-8079-9167923b8e23 | macvlan1 | fa:16:3e:0c:f5:bd | {"subnet_id": "5ec3c71b-3de4-41f2-b6fb-aaae7d51f3d6", "ip_address": "192.168.0.6"} |
| 6909b103-c795-4e0f-a8b3-a690d6578dc4 | macvlan2 | fa:16:3e:88:b8:d9 | {"subnet_id": "5ec3c71b-3de4-41f2-b6fb-aaae7d51f3d6", "ip_address": "192.168.0.7"} |
```


#### 3. On VM2, Create macvlan interface with the mac address generated by neutron:

```
# ip link add macvlan1 address fa:16:3e:0c:f5:bd link eth0 type macvlan mode bridge
# ip link add macvlan2 address fa:16:3e:88:b8:d9 link eth0 type macvlan mode bridge
```


#### 4. Create two network namespaces:

```
# ip netns add ns1
# ip netns add ns2
```


#### 5. Add macvlan into network namespaces and configure ip address and default route:

```
### Add macvlan into network namespace:
# ip link set macvlan1  netns ns1
# ip link set macvlan2  netns ns2

### Configure ip address and route
# ip netns exec ns1 ifconfig macvlan1 192.168.0.6/24 up
# ip netns exec ns2 ifconfig macvlan2 192.168.0.7/24 up
# ip netns exec ns1 ip route add 0.0.0.0/0 via 192.168.0.1
# ip netns exec ns2 ip route add 0.0.0.0/0 via 192.168.0.1
```

#### 6. Update allowed address pair on the port of VM2:

```
# neutron port-update --allowed-address-pair ip_address=192.168.0.6,mac_address=fa:16:3e:0c:f5:bd  --allowed-address-pair ip_address=192.168.0.7,mac_address=fa:16:3e:88:b8:d9 05380686-9db9-4979-93e7-b7431ef0d679
Updated port: 05380686-9db9-4979-93e7-b7431ef0d679

# neutron port-show 05380686-9db9-4979-93e7-b7431ef0d679
+-----------------------+------------------------------------------------------------------------------------+
| Field                 | Value                                                                              |
+-----------------------+------------------------------------------------------------------------------------+
| admin_state_up        | True                                                                               |
| allowed_address_pairs | {"ip_address": "192.168.0.6", "mac_address": "fa:16:3e:0c:f5:bd"}                  |
|                       | {"ip_address": "192.168.0.7", "mac_address": "fa:16:3e:88:b8:d9"}                  |
| binding:vnic_type     | normal                                                                             |
| created_at            | 2016-09-18T06:06:43                                                                |
| description           |                                                                                    |
| device_id             | 58907f59-65db-4190-b20d-d253b3a2b227                                               |
| device_owner          | compute:nova                                                                       |
| dns_name              |                                                                                    |
| extra_dhcp_opts       |                                                                                    |
| fixed_ips             | {"subnet_id": "5ec3c71b-3de4-41f2-b6fb-aaae7d51f3d6", "ip_address": "192.168.0.5"} |
| id                    | 05380686-9db9-4979-93e7-b7431ef0d679                                               |
| mac_address           | fa:16:3e:1b:6d:70                                                                  |
| name                  |                                                                                    |
| network_id            | 53abf3be-cbcd-428a-9c27-3be3357d182f                                               |
| port_security_enabled | True                                                                               |
| qos_policy_id         |                                                                                    |
| security_groups       | 8a0c6898-e335-4351-a6c7-41de219668f9                                               |
| status                | ACTIVE                                                                             |
| tenant_id             | b701b2d0922c41f580a063b0a1a020ba                                                   |
| updated_at            | 2016-09-18T06:31:48                                                                |
+-----------------------+------------------------------------------------------------------------------------+
```

#### 7. The two network namespace on VM2 can ping each other, it also can ping VM1 and outside.

```
### Ping the other network namespace
# ip netns exec ns2 ping 192.168.0.6
PING 192.168.0.6 (192.168.0.6) 56(84) bytes of data.
64 bytes from 192.168.0.6: icmp_seq=1 ttl=64 time=0.051 ms
64 bytes from 192.168.0.6: icmp_seq=2 ttl=64 time=0.046 ms

### Ping VM1
# ip netns exec ns2 ping 192.168.0.4
PING 192.168.0.4 (192.168.0.4) 56(84) bytes of data.
64 bytes from 192.168.0.4: icmp_seq=1 ttl=64 time=1.60 ms
64 bytes from 192.168.0.4: icmp_seq=2 ttl=64 time=0.431 ms
64 bytes from 192.168.0.4: icmp_seq=3 ttl=64 time=0.405 ms

### Ping external network
# ip netns exec ns2 ping g.cn
PING g.cn (74.125.68.160) 56(84) bytes of data.
64 bytes from sc-in-f160.1e100.net (74.125.68.160): icmp_seq=1 ttl=33 time=88.8 ms
64 bytes from sc-in-f160.1e100.net (74.125.68.160): icmp_seq=2 ttl=33 time=90.0 ms
```

## Summary
