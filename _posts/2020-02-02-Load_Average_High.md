---
title: DevOps -- Load Average High
---

> 在测试环境一台服务器有时会发生登陆不了的情况，Prometheus监控/报警显示服务器在发生问题时Load Average很高。本文记录一些debug过程。


由于有Prometheus监控，可以看到服务器发生问题时，Load Average一下很高，然后机器ssh不了，prometheus数据也无法收集。首先很容易定位什么触发了这个问题，这台机器上有CI job，问题发生时CI Job在跑一个Java应用的IT测试，只要触发这个IT测试可以稳定再现问题。

定位到时IT测试引起的问题后，查看CPU/内存的一些特征，可以看到CPU使用率很高，50%左右是在等待IO，Disk IO当时也很高，但是IT测试并没有对磁盘很多写。同样的测试在本地跑的时候对磁盘没有太多读写。
查看内存，可以看到内存在IT测试时很高，由此定位，是因为内存满了，导致交换到磁盘IO升高。
解决这个问题很容易，在IT测试时限制Java的内存大小，限制后问题解决。


Load Average升高有以下一些常见原因：
1. CPU密集使用   -- 这个很容易用top等工具判断是否有进程非常消耗CPU
2. CPU上下文切换 -- 此时CPU使用率未必高，可以查看上下文切换，考虑多进程相互抢占
3. RAM不足       -- 内存不足会导致磁盘交换，产生等待IO的进程，从而Load升高
4. DISK IO高     -- DISK IO会产生等待IO的不可中断进程
5. Lock          -- lock也是不可中断进程的一种，计算Load时会考虑
6. 网络请求高    -- 常见的有ri高，如网络请求密集


